<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Advanced Email Tracker</title>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body class="bg-gray-100">
    <div class="container mx-auto p-4">
      <h1 class="text-3xl font-bold mb-4">Advanced Email Tracker</h1>
      <form id="emailForm" class="mb-8">
        <input
          type="email"
          id="to"
          placeholder="Recipient Email"
          required
          class="w-full p-2 mb-2 border rounded"
        />
        <select id="template" class="w-full p-2 mb-2 border rounded">
          <option value="">Select a template</option>
        </select>
        <div id="templateVars"></div>
        <button
          type="submit"
          class="w-full p-2 bg-blue-500 text-white rounded hover:bg-blue-600"
        >
          Send Email
        </button>
      </form>
      <div id="result" class="mb-4"></div>
      <h2 class="text-2xl font-bold mb-2">Sent Emails</h2>
      <div id="emailList" class="space-y-2"></div>
      <div class="mt-8">
        <h2 class="text-2xl font-bold mb-2">Email Analytics</h2>
        <canvas id="analyticsChart"></canvas>
      </div>
    </div>

    <script>
      let chart;

      async function loadTemplates() {
        const response = await fetch("/templates");
        const templates = await response.json();
        const selectElement = document.getElementById("template");
        templates.forEach((template) => {
          const option = document.createElement("option");
          option.value = template.name;
          option.textContent = `${template.name} - ${template.subject}`;
          selectElement.appendChild(option);
        });
      }

      document.getElementById("template").addEventListener("change", (e) => {
        const templateName = e.target.value;
        const varsContainer = document.getElementById("templateVars");
        varsContainer.innerHTML = "";

        if (templateName === "welcome") {
          // No additional variables needed for welcome template
        } else if (templateName === "newsletter") {
          ["FEATURE_NAME", "CUSTOMER_NAME"].forEach((varName) => {
            const input = document.createElement("input");
            input.type = "text";
            input.id = varName.toLowerCase();
            input.placeholder = varName;
            input.className = "w-full p-2 mb-2 border rounded";
            varsContainer.appendChild(input);
          });
        }
      });

      document
        .getElementById("emailForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const to = document.getElementById("to").value;
          const templateName = document.getElementById("template").value;
          const templateVars = {};

          if (templateName === "newsletter") {
            templateVars.FEATURE_NAME =
              document.getElementById("feature_name").value;
            templateVars.CUSTOMER_NAME =
              document.getElementById("customer_name").value;
          }

          try {
            const response = await fetch("/send-email", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ to, templateName, templateVars }),
            });
            const data = await response.json();
            if (data.success) {
              document.getElementById("result").innerHTML = `
                        <div class="bg-green-100 border-l-4 border-green-500 text-green-700 p-4" role="alert">
                            <p>Email sent successfully. Email ID: ${data.emailId}</p>
                        </div>`;
              fetchEmails();
            } else {
              document.getElementById("result").innerHTML = `
                        <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4" role="alert">
                            <p>Failed to send email: ${data.error}</p>
                        </div>`;
            }
          } catch (error) {
            console.error("Error:", error);
            document.getElementById("result").innerHTML = `
                    <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4" role="alert">
                        <p>An error occurred while sending the email.</p>
                    </div>`;
          }
        });

      async function fetchEmails() {
        try {
          const response = await fetch("/emails");
          const emails = await response.json();
          const emailList = document.getElementById("emailList");
          emailList.innerHTML = emails
            .map(
              (email) => `
                    <div class="bg-white shadow-md rounded px-8 pt-6 pb-8 mb-4">
                        <p><strong>To:</strong> ${email.to}</p>
                        <p><strong>Template:</strong> ${email.templateName}</p>
                        <p><strong>Sent At:</strong> ${new Date(
                          email.sentAt
                        ).toLocaleString()}</p>
                        <p><strong>Status:</strong> ${
                          email.opened ? "Opened" : "Not Opened"
                        }</p>
                        <p><strong>Open Count:</strong> ${email.openCount}</p>
                        <p><strong>Click Count:</strong> ${email.clickCount}</p>
                        ${
                          email.opened
                            ? `<p><strong>First Opened At:</strong> ${new Date(
                                email.openedAt
                              ).toLocaleString()}</p>`
                            : ""
                        }
                    </div>
                `
            )
            .join("");
          updateAnalyticsChart(emails);
        } catch (error) {
          console.error("Error fetching emails:", error);
        }
      }

      function updateAnalyticsChart(emails) {
        const ctx = document.getElementById("analyticsChart").getContext("2d");
        const openCounts = emails.map((email) => email.openCount);
        const clickCounts = emails.map((email) => email.clickCount);
        const labels = emails.map((email) => email.to);

        if (chart) {
          chart.destroy();
        }

        chart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Open Count",
                data: openCounts,
                backgroundColor: "rgba(75, 192, 192, 0.2)",
                borderColor: "rgba(75, 192, 192, 1)",
                borderWidth: 1,
              },
              {
                label: "Click Count",
                data: clickCounts,
                backgroundColor: "rgba(153, 102, 255, 0.2)",
                borderColor: "rgba(153, 102, 255, 1)",
                borderWidth: 1,
              },
            ],
          },
          options: {
            scales: {
              y: {
                beginAtZero: true,
              },
            },
          },
        });
      }

      // Load templates and fetch emails on page load
      loadTemplates();
      fetchEmails();

      // Refresh email list and analytics every 30 seconds
      setInterval(fetchEmails, 30000);
    </script>
  </body>
</html>
