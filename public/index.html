<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Email Tracker Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.quilljs.com/1.3.6/quill.snow.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      .ql-container {
        height: 200px;
      }
    </style>
  </head>
  <body class="bg-gray-100 font-sans">
    <div class="flex h-screen">
      <!-- Sidebar -->
      <div class="bg-gray-800 text-white w-64 flex-shrink-0">
        <div class="p-4">
          <h1 class="text-2xl font-bold">Email Tracker</h1>
        </div>
        <nav class="mt-8">
          <a href="#" class="block py-2 px-4 bg-gray-900" id="compose-nav">
            <i class="fas fa-pen mr-2"></i> Compose
          </a>
          <a href="#" class="block py-2 px-4 hover:bg-gray-700" id="sent-nav">
            <i class="fas fa-paper-plane mr-2"></i> Sent Emails
          </a>
        </nav>
      </div>

      <!-- Main content -->
      <div class="flex-1 flex flex-col overflow-hidden">
        <!-- Top bar -->
        <header class="bg-white shadow-sm">
          <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8">
            <h2
              class="text-2xl font-bold leading-7 text-gray-900 sm:text-3xl sm:truncate"
              id="page-title"
            >
              Compose Email
            </h2>
          </div>
        </header>

        <!-- Main content area -->
        <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100">
          <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
            <!-- Compose Email Form -->
            <div
              id="compose-section"
              class="bg-white shadow overflow-hidden sm:rounded-lg"
            >
              <div class="px-4 py-5 sm:p-6">
                <form id="emailForm" class="space-y-4">
                  <div>
                    <label
                      for="to"
                      class="block text-sm font-medium text-gray-700"
                      >To</label
                    >
                    <input
                      type="email"
                      id="to"
                      required
                      class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                    />
                  </div>
                  <div>
                    <label
                      for="subject"
                      class="block text-sm font-medium text-gray-700"
                      >Subject</label
                    >
                    <input
                      type="text"
                      id="subject"
                      required
                      class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                    />
                  </div>
                  <div>
                    <label
                      for="editor"
                      class="block text-sm font-medium text-gray-700"
                      >Content</label
                    >
                    <div id="editor"></div>
                  </div>
                  <div>
                    <button
                      type="submit"
                      class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
                    >
                      Send Email
                    </button>
                  </div>
                </form>
              </div>
            </div>

            <!-- Sent Emails List -->
            <div
              id="sent-section"
              class="hidden bg-white shadow overflow-hidden sm:rounded-lg mt-6"
            >
              <div class="px-4 py-5 sm:p-6">
                <div id="emailList" class="space-y-4"></div>
              </div>
            </div>

            <!-- Result message -->
            <div id="result" class="mt-6"></div>
          </div>
        </main>
      </div>
    </div>

    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script>
      // Initialize Quill editor
      var quill = new Quill("#editor", {
        theme: "snow",
      });

      // Navigation
      document
        .getElementById("compose-nav")
        .addEventListener("click", function (e) {
          e.preventDefault();
          document.getElementById("compose-section").classList.remove("hidden");
          document.getElementById("sent-section").classList.add("hidden");
          document.getElementById("page-title").textContent = "Compose Email";
        });

      document
        .getElementById("sent-nav")
        .addEventListener("click", function (e) {
          e.preventDefault();
          document.getElementById("compose-section").classList.add("hidden");
          document.getElementById("sent-section").classList.remove("hidden");
          document.getElementById("page-title").textContent = "Sent Emails";
          fetchEmails();
        });

      document
        .getElementById("emailForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const to = document.getElementById("to").value;
          const subject = document.getElementById("subject").value;
          const content = quill.root.innerHTML;

          try {
            const response = await fetch("/send-email", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ to, subject, content }),
            });
            const data = await response.json();
            if (data.success) {
              document.getElementById("result").innerHTML = `
                        <div class="bg-green-100 border-l-4 border-green-500 text-green-700 p-4 rounded" role="alert">
                            <p class="font-bold">Success</p>
                            <p>Email sent successfully. Email ID: ${data.emailId}</p>
                        </div>`;
              fetchEmails();
              // Clear the form
              document.getElementById("to").value = "";
              document.getElementById("subject").value = "";
              quill.root.innerHTML = "";
            } else {
              document.getElementById("result").innerHTML = `
                        <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded" role="alert">
                            <p class="font-bold">Error</p>
                            <p>Failed to send email: ${data.error}</p>
                        </div>`;
            }
          } catch (error) {
            console.error("Error:", error);
            document.getElementById("result").innerHTML = `
                    <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded" role="alert">
                        <p class="font-bold">Error</p>
                        <p>An error occurred while sending the email.</p>
                    </div>`;
          }
        });

      async function fetchEmails() {
        try {
          const response = await fetch("/emails");
          const emails = await response.json();
          const emailList = document.getElementById("emailList");
          emailList.innerHTML = emails
            .map(
              (email) => `
                    <div class="bg-white shadow overflow-hidden sm:rounded-lg mb-4">
                        <div class="px-4 py-5 sm:px-6">
                            <h3 class="text-lg leading-6 font-medium text-gray-900">
                                ${email.subject}
                            </h3>
                            <p class="mt-1 max-w-2xl text-sm text-gray-500">
                                Sent to: ${email.to}
                            </p>
                        </div>
                        <div class="border-t border-gray-200 px-4 py-5 sm:px-6">
                            <dl class="grid grid-cols-1 gap-x-4 gap-y-8 sm:grid-cols-2">
                                <div class="sm:col-span-1">
                                    <dt class="text-sm font-medium text-gray-500">
                                        Sent At
                                    </dt>
                                    <dd class="mt-1 text-sm text-gray-900">
                                        ${new Date(
                                          email.sentAt
                                        ).toLocaleString()}
                                    </dd>
                                </div>
                                <div class="sm:col-span-1">
                                    <dt class="text-sm font-medium text-gray-500">
                                        Status
                                    </dt>
                                    <dd class="mt-1 text-sm text-gray-900">
                                        <span id="status-${
                                          email.id
                                        }" class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                email.opened
                  ? "bg-green-100 text-green-800"
                  : "bg-yellow-100 text-yellow-800"
              }">
                                            ${
                                              email.opened
                                                ? "Opened"
                                                : "Not Opened"
                                            }
                                        </span>
                                    </dd>
                                </div>
                                <div class="sm:col-span-2">
                                    <dt class="text-sm font-medium text-gray-500">
                                        Opened At
                                    </dt>
                                    <dd class="mt-1 text-sm text-gray-900" id="opened-at-${
                                      email.id
                                    }">
                                        ${
                                          email.opened
                                            ? new Date(
                                                email.openedAt
                                              ).toLocaleString()
                                            : "N/A"
                                        }
                                    </dd>
                                </div>
                                <div class="sm:col-span-2">
                                    <dt class="text-sm font-medium text-gray-500">
                                        Links
                                    </dt>
                                    <dd class="mt-1 text-sm text-gray-900">
                                        <ul class="border border-gray-200 rounded-md divide-y divide-gray-200">
                                            ${email.links
                                              .map(
                                                (link) => `
                                                <li class="pl-3 pr-4 py-3 flex items-center justify-between text-sm">
                                                    <div class="w-0 flex-1 flex items-center">
                                                        <span class="ml-2 flex-1 w-0 truncate">
                                                            ${link.originalUrl}
                                                        </span>
                                                    </div>
                                                    <div class="ml-4 flex-shrink-0">
                                                        <span id="link-status-${
                                                          link.id
                                                        }" class="font-medium text-indigo-600 hover:text-indigo-500">
                                                            ${
                                                              link.clicked
                                                                ? "Clicked"
                                                                : "Not Clicked"
                                                            }
                                                        </span>
                                                    </div>
                                                </li>
                                            `
                                              )
                                              .join("")}
                                        </ul>
                                    </dd>
                                </div>
                            </dl>
                        </div>
                    </div>
                `
            )
            .join("");
        } catch (error) {
          console.error("Error fetching emails:", error);
        }
      }

      async function checkEmailStatus() {
        try {
          const response = await fetch("/emails");
          const emails = await response.json();
          emails.forEach((email) => {
            const statusElement = document.getElementById(`status-${email.id}`);
            const openedAtElement = document.getElementById(
              `opened-at-${email.id}`
            );
            if (statusElement) {
              statusElement.textContent = email.opened
                ? "Opened"
                : "Not Opened";
              statusElement.className = `px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                email.opened
                  ? "bg-green-100 text-green-800"
                  : "bg-yellow-100 text-yellow-800"
              }`;
              if (email.opened && openedAtElement) {
                openedAtElement.textContent = new Date(
                  email.openedAt
                ).toLocaleString();
              }
            }
            email.links.forEach((link) => {
              const linkStatusElement = document.getElementById(
                `link-status-${link.id}`
              );
              if (linkStatusElement) {
                linkStatusElement.textContent = link.clicked
                  ? "Clicked"
                  : "Not Clicked";
                linkStatusElement.className = `font-medium ${
                  link.clicked
                    ? "text-green-600 hover:text-green-500"
                    : "text-indigo-600 hover:text-indigo-500"
                }`;
              }
            });
          });
        } catch (error) {
          console.error("Error checking email status:", error);
        }
      }

      // Check email status every 5 seconds
      setInterval(checkEmailStatus, 5000);
    </script>
  </body>
</html>
